# ===============================================================
# üèóÔ∏è  Continuous Integration Workflow for Django + React Project
# ---------------------------------------------------------------
# Enforces:
#   - Pull requests only (no direct commits to main)
#   - At least 2 peer approvals (one must be a PM)
#   - Linting, typing, and tests for both backend & frontend
#   - CI must pass before merge
# ===============================================================

name: CI

# ---------------------------------------------------------------
# Trigger conditions:
#   - Runs on pull requests (to main)
#   - Runs on other branches except main (for branch-level checks)
# ---------------------------------------------------------------
on:
  pull_request:
  push:
    branches-ignore:
      - main # main is protected, PRs only allowed

jobs:
  # -------------------------------------------------------------
  # ‚úÖ 1. Review Policy Enforcement
  # -------------------------------------------------------------
  # Ensures PRs have:
  #   - At least 2 approvals
  #   - At least one approval from a Product Manager
  # If this job fails, backend/frontend jobs won‚Äôt start.
  # -------------------------------------------------------------
  review-policy:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Validate review policy
        uses: actions/github-script@v7
        with:
          script: |
            // List of Product Manager GitHub usernames
            const pmUsers = ['Roshan-anand'];

            const pr = context.payload.pull_request;

            // Fetch PR review history
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            // Collect unique approved reviewers
            const approved = reviews.filter(r => r.state === 'APPROVED');
            const uniqueApprovers = [...new Set(approved.map(r => r.user.login))];

            // Rule 1: Require at least 2 approvals
            if (uniqueApprovers.length < 2) {
              core.setFailed(`‚ùå PR requires at least 2 approvals, currently has ${uniqueApprovers.length}`);
            }

            // Rule 2: Require at least one PM approval
            const hasPM = uniqueApprovers.some(u => pmUsers.includes(u));
            if (!hasPM) {
              core.setFailed('‚ùå PR must include at least one approval from a Product Manager.');
            }

  # -------------------------------------------------------------
  # üêç 2. Backend Checks (Django / Python)
  # -------------------------------------------------------------
  # Runs after review-policy passes.
  # Includes:
  #   - Poetry setup & dependency installation
  #   - Linting via Ruff
  #   - Static typing via MyPy
  #   - Tests via Pytest
  # -------------------------------------------------------------
  backend:
    runs-on: ubuntu-latest
    needs: review-policy # Wait until review-policy passes
    steps:
      # Checkout repository code
      - uses: actions/checkout@v4

      # Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # Install Poetry (Python dependency manager)
      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python -

      # Install all dependencies defined in pyproject.toml
      - name: Install dependencies
        run: poetry install
        working-directory: ./backend

      # Linting check (Ruff)
      - name: Lint
        run: poetry run ruff check .
        working-directory: ./backend

      # Type checking (MyPy)
      - name: Type check
        run: poetry run mypy .
        working-directory: ./backend

      # Run all tests (Pytest)
      - name: Tests
        run: poetry run pytest -q
        working-directory: ./backend

  # -------------------------------------------------------------
  # ‚öõÔ∏è 3. Frontend Checks (React / Node.js)
  # -------------------------------------------------------------
  # Runs after review-policy passes.
  # Includes:
  #   - Dependency install
  #   - Linting (ESLint)
  #   - Type checking (TypeScript)
  #   - Tests with coverage
  # -------------------------------------------------------------
  frontend:
    runs-on: ubuntu-latest
    needs: review-policy # Wait until review-policy passes
    steps:
      # Checkout repository code
      - uses: actions/checkout@v4

      # Setup Node.js environment
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Install Node dependencies using package-lock.json
      - name: Install
        run: npm ci
        working-directory: ./frontend

      # Run linting check (ESLint)
      - name: Lint
        run: npm run lint
        working-directory: ./frontend

      # Run TypeScript type checking
      - name: Typecheck
        run: npm run typecheck
        working-directory: ./frontend

      # Run unit tests and generate coverage report
      - name: Tests
        run: npm run test -- --coverage
        working-directory: ./frontend
